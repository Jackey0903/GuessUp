<view class="container">
  <!-- Round & Timer Banner (Multi-Round Only) -->
  <view class="round-banner glass {{timeRemaining <= 10 ? 'urgent' : ''}}" wx:if="{{roomId && totalRounds > 0}}">
    <text class="round-text">Round {{currentRound}} / {{totalRounds}}</text>
    <view class="timer">
      <text class="icon">â³</text>
      <text class="time">{{timeFormatted || '00:00'}}</text>
    </view>
  </view>

  <!-- Multiplayer Progress Trackers -->
  <view class="multiplayer-trackers glass" wx:if="{{roomId && opponents.length > 0}}">
    <view class="tracker-row" wx:for="{{opponents}}" wx:key="id">
      <view class="tracker-info">
        <text class="tracker-name">{{item.name}}</text>
        <text class="tracker-value">{{totalRounds > 0 ? item.guesses + '/10' : item.guesses + '/8'}}</text>
      </view>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{totalRounds > 0 ? (item.guesses >= 10 ? 100 : (item.guesses / 10) * 100) : (item.guesses / 8) * 100}}%"></view>
      </view>
    </view>
  </view>

  <!-- Search Area and Filters -->
  <view class="search-container" wx:if="{{gameState === 'playing'}}">
    
    <!-- Advanced Filters -->
    <view class="filter-bar">
      <picker bindchange="onConfChange" value="{{confIndex}}" range="{{conferences}}">
        <view class="filter-btn {{selectedConf ? 'active' : ''}}">
          {{selectedConf || 'è”ç›Ÿ'}} <text class="arrow-down">â–¼</text>
        </view>
      </picker>

      <picker bindchange="onTeamChange" value="{{teamIndex}}" range="{{teams}}">
        <view class="filter-btn {{selectedTeam ? 'active' : ''}}">
          {{selectedTeam || 'çƒé˜Ÿ'}} <text class="arrow-down">â–¼</text>
        </view>
      </picker>

      <picker bindchange="onPosChange" value="{{posIndex}}" range="{{positions}}">
        <view class="filter-btn {{selectedPos ? 'active' : ''}}">
          {{selectedPos || 'ä½ç½®'}} <text class="arrow-down">â–¼</text>
        </view>
      </picker>

      <view 
        class="filter-reset-btn" 
        wx:if="{{selectedConf || selectedTeam || selectedPos}}" 
        bindtap="resetFilters"
      >
        âœ•
      </view>
    </view>

    <!-- Search Input -->
    <view class="search-input-wrapper">
      <input 
        class="search-input" 
        placeholder="æœåå­—æˆ–é€‰æ¡ä»¶æŸ¥åå†Œ" 
        value="{{inputVal}}" 
        bindinput="onInput"
        placeholder-style="color: var(--muted); font-size: 28rpx;"
      />
      <view class="guess-count">{{guesses.length}} / 8</view>
    </view>
    <scroll-view scroll-y class="search-results" wx:if="{{searchResults.length > 0}}">
      <view 
        class="search-item" 
        wx:for="{{searchResults}}" 
        wx:key="id" 
        bindtap="selectPlayer" 
        data-player="{{item}}"
      >
        <view class="item-name">{{item.name}}</view>
        <text class="item-detail">{{item.team_cn}} - #{{item.number}}</text>
      </view>
    </scroll-view>
  </view>

  <!-- Game Grid -->
  <view class="game-board">
    <!-- Header Row -->
    <view class="grid-row headers">
      <view class="header-cell">çƒå‘˜</view>
      <view class="header-cell">çƒé˜Ÿ</view>
      <view class="header-cell">è”ç›Ÿ</view>
      <view class="header-cell">åˆ†åŒº</view>
      <view class="header-cell">ä½ç½®</view>
      <view class="header-cell">èº«é«˜</view>
      <view class="header-cell">å¹´é¾„</view>
      <view class="header-cell">å·ç </view>
    </view>

    <!-- Guesses -->
    <block wx:for="{{guesses}}" wx:key="index">
      <view class="grid-row guess-row fade-in">
        <view class="cell name-col {{item.name.status}}">{{item.name.value}}</view>
        <view class="cell {{item.team.status}}">
            <view class="content">{{item.team.value}}</view>
        </view>
        <view class="cell {{item.conf.status}}">{{item.conf.value}}</view>
        <view class="cell {{item.div.status}}">{{item.div.value}}</view>
        <view class="cell {{item.pos.status}}">{{item.pos.value}}</view>
        <view class="cell {{item.height.status}}">
          {{item.height.value}}
          <text wx:if="{{item.height.arrow === 'up'}}" class="arrow">â†‘</text>
          <text wx:if="{{item.height.arrow === 'down'}}" class="arrow">â†“</text>
        </view>
        <view class="cell {{item.age.status}}">
          {{item.age.value}}
          <text wx:if="{{item.age.arrow === 'up'}}" class="arrow">â†‘</text>
          <text wx:if="{{item.age.arrow === 'down'}}" class="arrow">â†“</text>
        </view>
        <view class="cell {{item.number.status}}">
          {{item.number.value}}
          <text wx:if="{{item.number.arrow === 'up'}}" class="arrow">â†‘</text>
          <text wx:if="{{item.number.arrow === 'down'}}" class="arrow">â†“</text>
        </view>
      </view>
    </block>
  </view>

  <!-- Result Modal -->
  <view class="modal-mask" wx:if="{{showModal}}">
    <view class="modal-content {{gameState}}">
      <view class="result-header">
        <block wx:if="{{roomId}}">
          <view class="result-title">{{gameState === 'won' ? 'ä½ èµ¢äº†ï¼' : (opponentWon ? 'å¯¹æ‰‹è·èƒœ' : 'ä½ è¾“äº†ï¼')}}</view>
          <view class="result-subtitle">{{gameState === 'won' ? 'æ— æƒ…ç¢¾å‹' : (opponentWon ? 'è¢«æ— æƒ…ç¢¾å‹' : 'é—æ†¾ç¦»åœº')}}</view>
        </block>
        <block wx:else>
          <view class="result-title">{{gameState === 'won' ? 'YOU WIN!' : 'GAME OVER'}}</view>
      <view class="result-subtitle">{{gameState === 'won' ? 'ç‰›é€¼ï¼ä½ çŒœä¸­äº†ï¼' : (winnerName ? 'é—æ†¾ï¼' + winnerName + 'ç‡å…ˆçŒœä¸­ï¼' : 'å¤ªé—æ†¾äº†...')}}</view>
        </block>
      </view>
      
      <view class="result-card">
        <view class="player-avatar">{{target.initials}}</view>
        <view class="player-name">{{target.name}}</view>
        <view class="player-detail">{{target.team_cn}} | #{{target.number}} | {{target.pos_cn}}</view>
      </view>

      <view class="action-buttons">
          <button class="share-btn primary" open-type="share" wx:if="{{!roomId}}">ç‚«è€€æˆ˜ç»©</button>
          <button class="restart-btn ghost" bindtap="startNewGame" wx:if="{{!roomId}}">é‡æ–°æŒ‘æˆ˜</button>
          
          <view wx:if="{{roomId}}" style="text-align: center; width: 100%; color: var(--muted); font-size: 28rpx; padding: 20rpx 0;">
            <text>å³å°†è¿›å…¥ä¸‹ä¸€è½®ï¼Œè¯·ç¨å€™...</text>
          </view>
      </view>
    </view>
  </view>

  <!-- Final Leaderboard Modal -->
  <view class="modal-mask" wx:if="{{gameState === 'finished'}}">
    <view class="modal-content result-modal glass" style="padding: 60rpx 40rpx; width: 90%;">
      <view class="result-header">
         <view class="result-title" style="font-size: 48rpx;">å…¨éƒ¨è½®æ¬¡ç»“æŸ</view>
         <view class="result-subtitle" style="color: var(--accent); margin-top: 10rpx;">ğŸ… æœ€ç»ˆæ’è¡Œæ¦œ ğŸ…</view>
      </view>
      
      <view class="leaderboard" style="margin: 40rpx 0; display: flex; flex-direction: column; gap: 20rpx;">
         <view class="lb-row glass" wx:for="{{leaderboard}}" wx:key="id" style="display: flex; align-items: center; padding: 24rpx; border-radius: 16rpx; gap: 24rpx; background: rgba(255,255,255,0.05);">
            <view class="lb-rank" style="font-size: 40rpx; font-weight: 900; color: {{index === 0 ? '#FFD700' : (index === 1 ? '#C0C0C0' : (index === 2 ? '#CD7F32' : 'var(--muted)'))}};">#{{index + 1}}</view>
            <view class="lb-info" style="flex: 1; display: flex; flex-direction: column; gap: 4rpx;">
              <text class="lb-name" style="font-size: 32rpx; font-weight: bold; color: #fff;">{{item.name}}</text>
              <text class="lb-score" style="font-size: 24rpx; color: var(--accent);">ç­”å¯¹ {{item.totalCorrect}} é¢˜ / è€—è´¹ {{item.totalAttempts}} çŒœ</text>
            </view>
            <view class="lb-time" style="font-size: 28rpx; color: rgba(255,255,255,0.6); font-variant-numeric: tabular-nums;">{{item.timeSecs}}s</view>
         </view>
      </view>

      <view class="action-buttons">
          <navigator url="/pages/index/index" open-type="reLaunch" class="restart-btn primary" style="display:flex; justify-content:center; align-items:center;">è¿”å›å¤§å…</navigator>
      </view>
    </view>
  </view>

</view>
